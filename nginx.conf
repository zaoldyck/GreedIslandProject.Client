
# 用于 WebSocket 的连接升级映射（保持你的原设置）
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  server_name localhost;

  # 如果产物在 browser 子目录，根目录指向 browser
  # 若产物直接在 /usr/share/nginx/html 根，则把 root 改回 /usr/share/nginx/html
  root /usr/share/nginx/html/browser;

  # 指定入口文件名为 index.csr.html（不是默认的 index.html）
  index index.csr.html;

  # -----------------------------
  # 1) 静态资源的 MIME 类型（确保正确类型返回，尤其是 .woff2）
  # -----------------------------
  include /etc/nginx/mime.types;
  types {
    application/wasm wasm;
    font/woff2 woff2;
  }

  # -----------------------------
  # 2) 压缩（文本资源）
  # -----------------------------
  gzip on;
  gzip_comp_level 6;
  gzip_min_length 1024;
  gzip_types
    text/plain text/css text/javascript application/javascript
    application/json application/manifest+json application/xml
    image/svg+xml;
  gzip_vary on;

  # -----------------------------
  # 3) 基础性能优化（可选）
  # -----------------------------
  sendfile on;
  etag on;                       # 启用 ETag，配合缓存更稳
  open_file_cache max=1000 inactive=60s;
  open_file_cache_valid 60s;
  open_file_cache_min_uses 2;
  open_file_cache_errors on;

  # -----------------------------
  # 4) SPA 路由回退
  # -----------------------------
  location / {
    try_files $uri $uri/ /index.csr.html;
  }

  # -----------------------------
  # 5) 字体长缓存（1 年 + immutable）
  #    你的字体位于 src/public/fonts -> /fonts
  # -----------------------------
  location /fonts/ {
    # 如果你愿意，也可以强制缓存所有静态子路径
    # expires 1y; 会设置一个一年后过期的 Date
    # 但更推荐明确的 Cache-Control 头：
    add_header Cache-Control "public, max-age=31536000, immutable";
    # 允许跨源字体（如需要）
    add_header Access-Control-Allow-Origin "*" always;
  }

  # -----------------------------
  # 6) 其它静态资源长缓存（基于文件后缀）
  #    Angular 产物通常带内容哈希，配合 immutable 更安全
  # -----------------------------
  location ~* \.(js|css)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
  }
  location ~* \.(png|jpg|jpeg|gif|webp|svg)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # 如果你有 public/assets 路径，也可以单独设定：
  location /assets/ {
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # -----------------------------
  # 7) 不缓存入口 HTML（确保路由/版本更新）
  # -----------------------------
  location = /index.csr.html {
    # 对 HTML 禁用长缓存，让新版本能立即生效
    add_header Cache-Control "no-cache, no-store, must-revalidate";
  }

  # -----------------------------
  # 8) 反代到后端容器（保留你的现有设置）
  # -----------------------------
  location /api/ {
    proxy_pass http://greedislandproject.server:8080/api/;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }
}

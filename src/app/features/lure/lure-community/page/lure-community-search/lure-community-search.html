<mat-card>
  <mat-card-content>
    <form [formGroup]="form" class="filter-form" (ngSubmit)="onSearch()">
      <div class="filter-row">
        <mat-form-field appearance="outline" floatLabel="always" class="filter-item-2">
          <mat-label>关键字</mat-label>
          <input matInput
                 placeholder="关键字"
                 formControlName="keyword"
                 (keydown.enter)="onSearch()" />

          <span matSuffix class="suffix-box">
            @if (form.controls.keyword.value) {
            <button mat-icon-button
                    type="button"
                    aria-label="清空关键字"
                    (click)="clearKeyword()">
              <mat-icon>close</mat-icon>
            </button>
            }
          </span>
        </mat-form-field>
        <mat-form-field appearance="outline" floatLabel="always" class="filter-item">
          <mat-select formControlName="scope">
            @for (opt of constants.lureCommunitySearchScopeDropdown; track opt.id) {
            <mat-option [value]="opt.id">
              {{ opt.name }}
            </mat-option>
            }
          </mat-select>
        </mat-form-field>
        <div class="filter-item filter-bar-btns">
          <button class="filter-bar-btn" matButton="tonal" type="button" (click)="onSearch()">
            <mat-icon>search</mat-icon>
            搜索
          </button>
        </div>
      </div>
      @if(form.controls.scope.value=='topics')
      {
      <div class="filter-row filter-row-extra-margin">
        <div class="filter-item">
          <a class="expandable-header pointer" (click)="toggleAdvancedOptions()">
            <mat-icon>
              {{ advancedOptionCollapsed() ? 'arrow_drop_down' : 'arrow_right' }}
            </mat-icon>
            <span>更多选项</span>
          </a>
        </div>
      </div>
      @if(advancedOptionCollapsed()){
      <div class="filter-row">

        <mat-form-field appearance="outline" class="filter-item">
          <mat-label>主题</mat-label>

          <mat-select formControlName="category" [compareWith]="compareById" (closed)="clearCategorySearch()">

            <mat-select-trigger>
              <span>{{ form.controls.category.value?.name }}</span>
            </mat-select-trigger>

            <!-- 搜索框：放在 disabled option 里 -->
            <mat-option disabled>
              <ngx-mat-select-search [formControl]="categorySearchCtrl"
                                     placeholderLabel="搜索..."
                                     noEntriesFoundLabel="没有匹配的选项">
              </ngx-mat-select-search>
            </mat-option>

            <!-- 你的清空项：用 --，非常合适 -->
            <mat-option [value]="null">  <mat-icon>filter_alt_off</mat-icon>--</mat-option>

            @if (filteredCategories$ | async; as categories) {
            @for (c of categories; track c.id) {

            <mat-option [value]="c">
              <mat-icon>{{ c.icon }}</mat-icon>

              <span>{{ c.name }}</span>
              <span class="opt-count"> × {{ c.lureCommunityTopicsCount }}</span>
            </mat-option>

            }
            }
          </mat-select>
        </mat-form-field>


        <mat-form-field appearance="outline" class="filter-item">
          <mat-label>标签</mat-label>

          <mat-select formControlName="tags"
                      multiple
                      [compareWith]="compareById"
                      (closed)="clearTagSearch()" >

            <!-- 搜索框：只能放在一个 disabled 的 mat-option 里，且它必须是“单独一行” -->
            <mat-option disabled class="select-search-option">
              <ngx-mat-select-search [formControl]="tagSearchCtrl"
                                     placeholderLabel="搜索..."
                                     noEntriesFoundLabel="没有匹配的选项">
              </ngx-mat-select-search>
            </mat-option>

            <!-- 二级结构：mat-optgroup = TagType，mat-option = Tag -->
            @if (filteredTagTypes$ | async; as typeList) {
            @for (t of typeList; track t.id) {
            <mat-optgroup [label]="t.name?? '(未命名类型)'">
              @for (tag of t.tags; track tag.id) {
              <mat-option [value]="tag">
                {{ tag.name }}
              </mat-option>
              }
            </mat-optgroup>
            }
            }

          </mat-select>
        </mat-form-field>

      </div>
      <div class="filter-row">
        <mat-form-field appearance="outline"   class="filter-item">
          <mat-label>作者</mat-label>
          <mat-select formControlName="scope">
            @for (opt of constants.lureCommunitySearchScopeDropdown; track opt.id) {
            <mat-option [value]="opt.id">
              {{ opt.name }}
            </mat-option>
            }
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline"  class="filter-item">
          <mat-label>发布日期</mat-label>
          <mat-select formControlName="scope">
            @for (opt of constants.lureCommunitySearchScopeDropdown; track opt.id) {
            <mat-option [value]="opt.id">
              {{ opt.name }}
            </mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
      <div class="filter-row filter-row-extra-margin">
        <div class="filter-item">
          <a class="expandable-header-small pointer" (click)="togglePostOptions()">
            <mat-icon>
              {{ postOptionCollapsed() ? 'arrow_drop_down' : 'arrow_right' }}
            </mat-icon>
            <span>按话题的回复量和浏览量过滤</span>
          </a>
        </div>
      </div>
      @if(postOptionCollapsed()){
      <div class="filter-row">
        <div class="filter-item-group">
          <mat-form-field appearance="outline" floatLabel="always" class="filter-item">
            <mat-label>最小回复量</mat-label>
            <input matInput />
          </mat-form-field>
          <mat-form-field appearance="outline" floatLabel="always" class="filter-item">
            <mat-label>最大回复量</mat-label>
            <input matInput />
          </mat-form-field>
        </div>
        <div class="filter-item-group">
          <mat-form-field appearance="outline" floatLabel="always" class="filter-item">
            <mat-label>最小浏览量</mat-label>
            <input matInput />
          </mat-form-field>
          <mat-form-field appearance="outline" floatLabel="always" class="filter-item">
            <mat-label>最大浏览量</mat-label>
            <input matInput />
          </mat-form-field>
        </div>
      </div>
      }
      }

      }
    </form>
  </mat-card-content>
</mat-card>

<form [formGroup]="form" class="filter-bar" (ngSubmit)="onSearch()">

  <mat-form-field appearance="outline" floatLabel="always" class="filter-item">
    <mat-label>搜索关键字</mat-label>
    <input matInput
           placeholder="请输入关键字"
           formControlName="keyword"
           (keydown.enter)="onSearch()" />

    <span matSuffix class="suffix-box">
      @if (form.controls.keyword.value) {
      <button mat-icon-button
              type="button"
              aria-label="清空关键字"
              (click)="clearKeyword()">
        <mat-icon>close</mat-icon>
      </button>
      }

      <button mat-icon-button
              type="submit"
              aria-label="搜索">
        <mat-icon>search</mat-icon>
      </button>
    </span>
  </mat-form-field>

  <mat-form-field appearance="outline"
                  floatLabel="always"
                  class="filter-item filter-tags pointer"
                  (click)="openTagSelectDialog()">
    <mat-label>标签</mat-label>

    <!-- infix 内容：已选标签（保持你原来的 chips） -->
    <mat-chip-grid aria-label="已选择的标签">
      @for (tag of form.controls.tags.value; track tag.id) {
      <mat-chip-row class="selected-chip"
                    [style.--chip-color]="tag.typeColor"
                    [removable]="true"
                    (removed)="removeTag(tag)"
                    (click)="$event.stopPropagation()">
        {{ tag.name }}
        <button matChipRemove aria-label="移除标签">
          <mat-icon>close</mat-icon>
        </button>
      </mat-chip-row>
      }
    </mat-chip-grid>

    <!-- 后缀按钮：打开标签选择弹窗（位于最右侧） -->
    <button mat-icon-button
            matSuffix
            type="button"
            aria-label="选择标签"
            (click)="$event.stopPropagation(); openTagSelectDialog()">
      <mat-icon>tune</mat-icon>
    </button>
  </mat-form-field>
  @if (form.controls.tags.value.length >= 2) {

  <mat-slide-toggle [checked]="form.controls.matchMode.value === 'OR'"
                    (change)="onMatchModeChange($event)"
                    class="switch-slide-toggle filter-slide-toggle"
                    [hideIcon]="true"
                    aria-label="匹配模式切换">
    {{ form.controls.matchMode.value === 'AND' ? '匹配全部标签' : '匹配任意标签' }}
  </mat-slide-toggle>

  }
  <div class="filter-item filter-bar-btns">

    <button class="filter-bar-btn" matButton="tonal" type="button" (click)="reset()">重置</button>
  </div>
</form>

@let list = items();

@if (list.length > 0) {
<div class="card-list">
  @for (item of list; track item.id) {
  <mat-card matRipple class="app-card pointer" (click)="onOpenDetail(item.id)">
    <mat-card-header class="app-card-header">
      <mat-card-title>{{ item.name }}</mat-card-title>
      <mat-card-subtitle>{{ item.englishName }}</mat-card-subtitle>
    </mat-card-header>

    <div class="image-box stretch">
      <img mat-card-image
           [src]="resolveImageUrl(item.imageUrl)"
           (error)="onImgError($event)">
    </div>

    <mat-card-content class="app-card-content">
      <p>{{ item.description }}</p>
    </mat-card-content>
  </mat-card>
  }
</div>
}

<!-- 无按钮版本的底部状态 -->
<div class="footer">

  @if (isLoading()) {
  <div><mat-spinner [diameter]="32"></mat-spinner></div>
  } @else if (noMore()) {
  <div class="divider-text">已到底部</div>
  }
</div>
